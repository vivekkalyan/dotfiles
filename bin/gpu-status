#!/usr/bin/env -S uv run --quiet --script
# /// script
# requires-python = ">=3.10"
# dependencies = [
#     "rich",
# ]
# ///
"""
GPU Status - Show GPU allocation in Kubernetes cluster
"""

import json
import subprocess
import sys
from collections import defaultdict

from rich.console import Console
from rich.table import Table


def run_kubectl(args: list[str]) -> dict | list | None:
    try:
        result = subprocess.run(
            ["kubectl"] + args + ["-o", "json"],
            capture_output=True,
            text=True,
            check=True,
        )
        return json.loads(result.stdout)
    except subprocess.CalledProcessError as e:
        print(f"Error running kubectl: {e.stderr}", file=sys.stderr)
        return None
    except json.JSONDecodeError:
        return None


def get_node_gpu_info() -> dict[str, dict]:
    nodes_data = run_kubectl(["get", "nodes"])
    if not nodes_data:
        return {}

    nodes = {}
    for node in nodes_data.get("items", []):
        name = node["metadata"]["name"]
        labels = node["metadata"].get("labels", {})
        allocatable = node["status"].get("allocatable", {})

        gpu_count = allocatable.get("nvidia.com/gpu", "0")
        if gpu_count == "<none>" or gpu_count == "0":
            continue

        gpu_model = labels.get("gpu.nvidia.com/model", labels.get("gpu.nvidia.com/class", "Unknown"))
        gpu_vram = labels.get("gpu.nvidia.com/vram", "?")

        nodes[name] = {
            "total_gpus": int(gpu_count),
            "model": gpu_model,
            "vram": gpu_vram,
            "used_gpus": 0,
            "pods": [],
        }

    return nodes


def get_pod_gpu_usage(nodes: dict[str, dict]) -> None:
    pods_data = run_kubectl(["get", "pods", "--all-namespaces", "--field-selector=status.phase=Running"])
    if not pods_data:
        return

    for pod in pods_data.get("items", []):
        node_name = pod["spec"].get("nodeName")
        if not node_name or node_name not in nodes:
            continue

        pod_name = pod["metadata"]["name"]
        namespace = pod["metadata"]["namespace"]

        gpu_request = 0
        for container in pod["spec"].get("containers", []):
            resources = container.get("resources", {})
            requests = resources.get("requests", {})
            limits = resources.get("limits", {})

            gpu_req = requests.get("nvidia.com/gpu", limits.get("nvidia.com/gpu", "0"))
            try:
                gpu_request += int(gpu_req)
            except (ValueError, TypeError):
                pass

        if gpu_request > 0:
            nodes[node_name]["used_gpus"] += gpu_request
            nodes[node_name]["pods"].append({
                "name": pod_name,
                "namespace": namespace,
                "gpus": gpu_request,
            })


def main():
    console = Console()

    with console.status("[bold blue]Fetching GPU status from cluster..."):
        nodes = get_node_gpu_info()
        if not nodes:
            console.print("[red]No GPU nodes found in cluster[/red]")
            sys.exit(1)

        get_pod_gpu_usage(nodes)

    summary = defaultdict(lambda: {"total": 0, "used": 0, "nodes": 0})
    nodes_idle = 0
    nodes_partial = 0
    nodes_full = 0

    for node_info in nodes.values():
        summary[node_info["model"]]["total"] += node_info["total_gpus"]
        summary[node_info["model"]]["used"] += node_info["used_gpus"]
        summary[node_info["model"]]["nodes"] += 1

        used = node_info["used_gpus"]
        total = node_info["total_gpus"]
        if used == 0:
            nodes_idle += 1
        elif used < total:
            nodes_partial += 1
        else:
            nodes_full += 1

    summary_table = Table(title="GPU Summary by Type", show_header=True, min_width=75)
    summary_table.add_column("GPU Model", style="cyan")
    summary_table.add_column("Nodes", justify="right")
    summary_table.add_column("Total GPUs", justify="right")
    summary_table.add_column("Used", justify="right")
    summary_table.add_column("Available", justify="right", style="green")
    summary_table.add_column("Utilization", justify="right")

    total_gpus = 0
    total_used = 0

    for model in sorted(summary.keys()):
        info = summary[model]
        available = info["total"] - info["used"]
        util_pct = (info["used"] / info["total"] * 100) if info["total"] > 0 else 0

        util_style = "green" if util_pct < 50 else "yellow" if util_pct < 80 else "red"

        summary_table.add_row(
            model,
            str(info["nodes"]),
            str(info["total"]),
            str(info["used"]),
            str(available),
            f"[{util_style}]{util_pct:.0f}%[/{util_style}]",
        )
        total_gpus += info["total"]
        total_used += info["used"]

    total_available = total_gpus - total_used
    total_util = (total_used / total_gpus * 100) if total_gpus > 0 else 0
    total_style = "green" if total_util < 50 else "yellow" if total_util < 80 else "red"

    summary_table.add_section()
    summary_table.add_row(
        "[bold]TOTAL[/bold]",
        f"[bold]{len(nodes)}[/bold]",
        f"[bold]{total_gpus}[/bold]",
        f"[bold]{total_used}[/bold]",
        f"[bold green]{total_available}[/bold green]",
        f"[bold {total_style}]{total_util:.0f}%[/bold {total_style}]",
    )

    console.print()
    console.print(summary_table)
    console.print()

    node_table = Table(title="GPU Nodes", show_header=True, min_width=75)
    node_table.add_column("Node", style="cyan", max_width=15)
    node_table.add_column("GPU Model")
    node_table.add_column("VRAM", justify="right")
    node_table.add_column("Used/Total", justify="right")
    node_table.add_column("Status")
    node_table.add_column("Pods Using GPUs")

    def node_sort_key(item):
        name, info = item
        used = info["used_gpus"]
        total = info["total_gpus"]
        if used == 0:
            return (0, name)  # Idle
        elif used < total:
            return (1, name)  # Partial
        else:
            return (2, name)  # Full

    sorted_nodes = sorted(nodes.items(), key=node_sort_key)

    for node_name, info in sorted_nodes:
        used = info["used_gpus"]
        total = info["total_gpus"]

        if used == 0:
            status = "[green]● Idle[/green]"
        elif used < total:
            status = "[yellow]● Partial[/yellow]"
        else:
            status = "[red]● Full[/red]"

        def format_pod(pod: dict, max_len: int = 40) -> str:
            suffix = f"({pod['gpus']})"
            name = pod["name"]
            available = max_len - len(suffix)
            if len(name) > available:
                name = name[:available - 1] + "…"
            return f"{name}{suffix}"

        pod_entries = [format_pod(p) for p in info["pods"][:3]]
        if len(info["pods"]) > 3:
            pod_entries.append(f"+{len(info['pods']) - 3} more")
        pod_list = "\n".join(pod_entries)

        node_table.add_row(
            node_name,
            info["model"],
            f"{info['vram']}GB" if info["vram"] != "?" else "?",
            f"{used}/{total}",
            status,
            pod_list or "-",
        )

    node_table.add_section()
    node_table.add_row(
        "[bold]TOTAL[/bold]",
        "",
        "",
        "",
        f"[green]{nodes_idle}[/green] / [yellow]{nodes_partial}[/yellow] / [red]{nodes_full}[/red]",
        f"[dim]Idle / Partial / Full[/dim]",
    )

    console.print(node_table)
    console.print()

    pod_table = Table(title="Pods Using GPUs", show_header=True, min_width=75)
    pod_table.add_column("Namespace", style="dim")
    pod_table.add_column("Pod Name", style="cyan")
    pod_table.add_column("Node")
    pod_table.add_column("GPUs", justify="right", style="yellow")

    all_pods = []
    for node_name, info in nodes.items():
        for pod in info["pods"]:
            all_pods.append({
                "node": node_name,
                "namespace": pod["namespace"],
                "name": pod["name"],
                "gpus": pod["gpus"],
            })

    all_pods.sort(key=lambda x: (x["namespace"], x["name"]))

    for pod in all_pods:
        pod_table.add_row(
            pod["namespace"],
            pod["name"],
            pod["node"],
            str(pod["gpus"]),
        )

    if all_pods:
        console.print(pod_table)
    else:
        console.print("[dim]No pods currently using GPUs[/dim]")


if __name__ == "__main__":
    main()
